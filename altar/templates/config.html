<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cathedral - Configuration</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .input-field { @apply w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded text-gray-100 focus:border-purple-500 focus:outline-none; }
        .btn { @apply px-4 py-2 rounded font-medium transition-colors; }
        .btn-primary { @apply bg-purple-600 hover:bg-purple-700 text-white; }
        .btn-secondary { @apply bg-gray-600 hover:bg-gray-700 text-white; }
        .status-ok { @apply text-green-400; }
        .status-warning { @apply text-yellow-400; }
        .status-error { @apply text-red-400; }
        .category-header { @apply text-lg font-semibold text-purple-400 border-b border-gray-700 pb-2 mb-4; }
        .config-row { @apply mb-4 p-4 bg-gray-800 rounded-lg; }
        .toggle-switch { @apply relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none; }
        .toggle-dot { @apply inline-block h-4 w-4 transform rounded-full bg-white transition-transform; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-purple-400">Cathedral Configuration</h1>
                <p class="text-gray-400 mt-1">Manage system settings and API keys</p>
            </div>
            <a href="/" class="btn btn-secondary">Back to Chat</a>
        </div>

        <!-- Status Banner -->
        <div id="status-banner" class="mb-6 p-4 rounded-lg hidden">
            <div class="flex items-center gap-3">
                <span id="status-icon" class="text-2xl"></span>
                <div>
                    <div id="status-text" class="font-medium"></div>
                    <div id="status-detail" class="text-sm opacity-75"></div>
                </div>
            </div>
        </div>

        <!-- Missing Config Alert -->
        <div id="missing-alert" class="mb-6 p-4 bg-red-900/50 border border-red-700 rounded-lg hidden">
            <h3 class="font-semibold text-red-400 mb-2">Missing Required Configuration</h3>
            <ul id="missing-list" class="list-disc list-inside text-sm text-red-300"></ul>
        </div>

        <!-- Config Form -->
        <form id="config-form" class="space-y-8">
            <!-- Categories will be populated by JS -->
        </form>

        <!-- Actions -->
        <div class="flex gap-4 mt-8 pt-6 border-t border-gray-700">
            <button type="submit" form="config-form" class="btn btn-primary">
                Save Configuration
            </button>
            <button type="button" onclick="reloadConfig()" class="btn btn-secondary">
                Reload from Disk
            </button>
            <button type="button" onclick="downloadEnvTemplate()" class="btn btn-secondary">
                Download .env Template
            </button>
        </div>

        <!-- Toast -->
        <div id="toast" class="fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg hidden transition-all transform translate-y-2 opacity-0">
            <span id="toast-message"></span>
        </div>
    </div>

    <script>
        let schema = {};
        let currentConfig = {};

        const categoryLabels = {
            api_keys: 'API Keys',
            database: 'Database',
            paths: 'Paths',
            server: 'Server',
            models: 'Models',
            features: 'Features'
        };

        const categoryIcons = {
            api_keys: 'üîë',
            database: 'üóÑÔ∏è',
            paths: 'üìÅ',
            server: 'üåê',
            models: 'ü§ñ',
            features: '‚öôÔ∏è'
        };

        async function loadConfig() {
            try {
                // Load schema
                const schemaRes = await fetch('/api/config/schema');
                schema = await schemaRes.json();

                // Load current values
                const configRes = await fetch('/api/config');
                currentConfig = await configRes.json();

                // Load status
                const statusRes = await fetch('/api/config/status');
                const status = await statusRes.json();

                renderForm();
                renderStatus(status);
            } catch (e) {
                showToast('Error loading configuration: ' + e.message, 'error');
            }
        }

        function renderForm() {
            const form = document.getElementById('config-form');
            form.innerHTML = '';

            for (const [category, fields] of Object.entries(schema)) {
                if (!fields || fields.length === 0) continue;

                const section = document.createElement('div');
                section.className = 'config-section';
                section.innerHTML = `
                    <h2 class="category-header">
                        ${categoryIcons[category] || 'üìã'} ${categoryLabels[category] || category}
                    </h2>
                `;

                const fieldContainer = document.createElement('div');
                fieldContainer.className = 'space-y-4';

                for (const field of fields) {
                    fieldContainer.appendChild(createFieldElement(field));
                }

                section.appendChild(fieldContainer);
                form.appendChild(section);
            }
        }

        function createFieldElement(field) {
            const value = currentConfig[field.key];
            const div = document.createElement('div');
            div.className = 'config-row';

            let inputHtml = '';

            if (field.type === 'boolean') {
                const checked = value === true || value === 'true';
                inputHtml = `
                    <button type="button"
                            onclick="toggleBoolean('${field.key}')"
                            class="toggle-switch ${checked ? 'bg-purple-600' : 'bg-gray-600'}"
                            id="toggle-${field.key}">
                        <span class="toggle-dot ${checked ? 'translate-x-5' : 'translate-x-1'}"></span>
                    </button>
                    <input type="hidden" name="${field.key}" id="${field.key}" value="${checked}">
                `;
            } else if (field.options && field.options.length > 0) {
                const options = field.options.map(opt =>
                    `<option value="${opt}" ${value === opt ? 'selected' : ''}>${opt}</option>`
                ).join('');
                inputHtml = `<select name="${field.key}" id="${field.key}" class="input-field">${options}</select>`;
            } else if (field.type === 'secret') {
                inputHtml = `
                    <div class="relative">
                        <input type="password" name="${field.key}" id="${field.key}"
                               value="${value || ''}"
                               class="input-field pr-10"
                               placeholder="${field.required ? 'Required' : 'Optional'}">
                        <button type="button" onclick="togglePassword('${field.key}')"
                                class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-200">
                            üëÅ
                        </button>
                    </div>
                `;
            } else if (field.type === 'integer') {
                inputHtml = `<input type="number" name="${field.key}" id="${field.key}"
                                    value="${value || field.default || ''}" class="input-field">`;
            } else {
                inputHtml = `<input type="text" name="${field.key}" id="${field.key}"
                                    value="${value || ''}"
                                    class="input-field"
                                    placeholder="${field.default || ''}">`;
            }

            div.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <label for="${field.key}" class="font-medium text-gray-200">
                        ${field.key}
                        ${field.required ? '<span class="text-red-400">*</span>' : ''}
                    </label>
                    ${field.restart_required ? '<span class="text-xs text-yellow-500">Restart required</span>' : ''}
                </div>
                <p class="text-sm text-gray-400 mb-2">${field.description}</p>
                ${inputHtml}
            `;

            return div;
        }

        function toggleBoolean(key) {
            const input = document.getElementById(key);
            const toggle = document.getElementById('toggle-' + key);
            const dot = toggle.querySelector('.toggle-dot');

            const newValue = input.value !== 'true';
            input.value = newValue;

            if (newValue) {
                toggle.classList.remove('bg-gray-600');
                toggle.classList.add('bg-purple-600');
                dot.classList.add('translate-x-5');
                dot.classList.remove('translate-x-1');
            } else {
                toggle.classList.add('bg-gray-600');
                toggle.classList.remove('bg-purple-600');
                dot.classList.remove('translate-x-5');
                dot.classList.add('translate-x-1');
            }
        }

        function togglePassword(key) {
            const input = document.getElementById(key);
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        function renderStatus(status) {
            const banner = document.getElementById('status-banner');
            const icon = document.getElementById('status-icon');
            const text = document.getElementById('status-text');
            const detail = document.getElementById('status-detail');
            const missingAlert = document.getElementById('missing-alert');
            const missingList = document.getElementById('missing-list');

            banner.classList.remove('hidden', 'bg-green-900/50', 'bg-yellow-900/50', 'bg-red-900/50');

            if (status.status === 'ok' && status.missing.length === 0) {
                banner.classList.add('bg-green-900/50');
                icon.textContent = '‚úì';
                icon.className = 'text-2xl text-green-400';
                text.textContent = 'Configuration Complete';
                text.className = 'font-medium text-green-400';
                detail.textContent = `${status.configured_count} settings configured`;
                missingAlert.classList.add('hidden');
            } else if (status.required_missing > 0) {
                banner.classList.add('bg-red-900/50');
                icon.textContent = '!';
                icon.className = 'text-2xl text-red-400';
                text.textContent = 'Missing Required Configuration';
                text.className = 'font-medium text-red-400';
                detail.textContent = `${status.required_missing} required setting(s) missing`;

                missingAlert.classList.remove('hidden');
                missingList.innerHTML = status.missing
                    .filter(m => m.required !== false)
                    .map(m => `<li>${m.key}: ${m.description}</li>`)
                    .join('');
            } else {
                banner.classList.add('bg-yellow-900/50');
                icon.textContent = '‚ö†';
                icon.className = 'text-2xl text-yellow-400';
                text.textContent = 'Configuration Incomplete';
                text.className = 'font-medium text-yellow-400';
                detail.textContent = `${status.missing.length} optional setting(s) not configured`;
                missingAlert.classList.add('hidden');
            }
        }

        document.getElementById('config-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const updates = {};

            for (const [key, value] of formData.entries()) {
                updates[key] = value;
            }

            try {
                const res = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updates)
                });

                if (res.ok) {
                    showToast('Configuration saved successfully', 'success');
                    loadConfig(); // Reload to refresh status
                } else {
                    const error = await res.json();
                    showToast('Error: ' + (error.detail || 'Save failed'), 'error');
                }
            } catch (e) {
                showToast('Error saving configuration: ' + e.message, 'error');
            }
        });

        async function reloadConfig() {
            try {
                await fetch('/api/config/reload', { method: 'POST' });
                loadConfig();
                showToast('Configuration reloaded', 'success');
            } catch (e) {
                showToast('Error reloading: ' + e.message, 'error');
            }
        }

        async function downloadEnvTemplate() {
            try {
                const res = await fetch('/api/config/template');
                const text = await res.text();

                const blob = new Blob([text], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = '.env.example';
                a.click();
                URL.revokeObjectURL(url);

                showToast('Template downloaded', 'success');
            } catch (e) {
                showToast('Error downloading: ' + e.message, 'error');
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastMsg = document.getElementById('toast-message');

            toast.className = 'fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg transition-all transform';

            if (type === 'success') {
                toast.classList.add('bg-green-800', 'text-green-100');
            } else if (type === 'error') {
                toast.classList.add('bg-red-800', 'text-red-100');
            } else {
                toast.classList.add('bg-gray-800', 'text-gray-100');
            }

            toastMsg.textContent = message;
            toast.classList.remove('hidden', 'translate-y-2', 'opacity-0');

            setTimeout(() => {
                toast.classList.add('translate-y-2', 'opacity-0');
                setTimeout(() => toast.classList.add('hidden'), 300);
            }, 3000);
        }

        // Load on page ready
        loadConfig();
    </script>
</body>
</html>
